<Project Sdk="Microsoft.NET.Sdk">

  <Import Project="..\Shared\FileSystemSources.proj" />
  <Import Project="..\Shared\DebuggingSources.proj" />

  <PropertyGroup>
    <TargetFrameworks>$(FullFrameworkTFM);$(LatestDotNetCoreForMSBuild)</TargetFrameworks>
    <RootNamespace>Microsoft.Build</RootNamespace>
    <AssemblyName>Microsoft.Build</AssemblyName>

    <AllowUnsafeBlocks>true</AllowUnsafeBlocks>
    <DefineConstants>$(DefineConstants);BUILD_ENGINE</DefineConstants>

    <GenerateReferenceAssemblySource>true</GenerateReferenceAssemblySource>
    <!-- Do not create Tlbs when building in .NET product mode. The packages are not shipped to VS,
         only their contents redisted within the SDK. -->
    <CreateTlb Condition="'$(DotNetBuild)' != 'true'">true</CreateTlb>
    <IsPackable>true</IsPackable>
    <PackageDescription>This package contains the $(MSBuildProjectName) assembly which is used to create, edit, and evaluate MSBuild projects.</PackageDescription>
    <IncludeSatelliteOutputInPack>false</IncludeSatelliteOutputInPack>
    <ApplyNgenOptimization Condition="'$(TargetFramework)' == '$(FullFrameworkTFM)'">full</ApplyNgenOptimization>
    <EnablePackageValidation>true</EnablePackageValidation>
    <GeneratePackageOnBuild>True</GeneratePackageOnBuild>

    <!-- Do not generate a warning that our 'stable' package should not have a prerelease dependency. -->
    <NoWarn>$(NoWarn);NU5104</NoWarn>
  </PropertyGroup>

  <ItemGroup>
    <ProjectReference Include="..\Framework\Microsoft.Build.Framework.csproj" />
    <ProjectReference Include="..\StringTools\StringTools.csproj" />
    <PackageReference Include="Microsoft.VisualStudio.SolutionPersistence" PrivateAssets="all" />
    <PackageReference Include="System.Configuration.ConfigurationManager" />

    <PackageReference Include="System.Reflection.MetadataLoadContext" />

    <PackageReference Include="Microsoft.IO.Redist" Condition="'$(FeatureMSIORedist)' == 'true'" />

    <PackageReference Include="Microsoft.BuildXL.Processes" Condition="'$(FeatureReportFileAccesses)' == 'true'" PrivateAssets="all" />
    <!-- Remove the direct NETStandard.Library dependency when Microsoft.BuildXL.Processes stops bringing in netstandard1.x dependencies
         or when a .NET 10 SDK is used (NuGet Package Pruning eliminates netstandard1.x dependencies). -->
    <PackageReference Include="NETStandard.Library" VersionOverride="2.0.3" PrivateAssets="all" Condition="'$(FeatureReportFileAccesses)' == 'true'" />
  </ItemGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.CodeAnalysis.Collections" PrivateAssets="all" />

    <!-- Display files included by the Microsoft.CodeAnalysis.Collections source package in a 'SourcePackages\Collections' folder -->
    <Content Update="@(Content)">
      <Link Condition="'%(NuGetPackageId)' == 'Microsoft.CodeAnalysis.Collections'">SourcePackages\Collections\%(Link)</Link>
    </Content>
    <Compile Update="@(Compile)">
      <Link Condition="'%(NuGetPackageId)' == 'Microsoft.CodeAnalysis.Collections'">SourcePackages\Collections\%(Link)</Link>
    </Compile>
  </ItemGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.CodeAnalysis.PooledObjects" PrivateAssets="all" />

    <!-- Display files included by the Microsoft.CodeAnalysis.PooledObjects source package in a 'SourcePackages\PooledObjects' folder -->
    <Content Update="@(Content)">
      <Link Condition="'%(NuGetPackageId)' == 'Microsoft.CodeAnalysis.PooledObjects'">SourcePackages\PooledObjects\%(Link)</Link>
    </Content>
    <Compile Update="@(Compile)">
      <Link Condition="'%(NuGetPackageId)' == 'Microsoft.CodeAnalysis.PooledObjects'">SourcePackages\PooledObjects\%(Link)</Link>
    </Compile>
  </ItemGroup>

  <ItemGroup Condition="'$(TargetFrameworkIdentifier)' == '.NETFramework' and '$(DotNetBuildSourceOnly)' != 'true'">
    <PackageReference Include="Microsoft.VisualStudio.Setup.Configuration.Interop" PrivateAssets="all" />
  </ItemGroup>
  <ItemGroup Condition="'$(TargetFrameworkIdentifier)' == '.NETFramework'">
    <Reference Include="System.IO.Compression" />
    <PackageReference Include="System.Memory" />
    <PackageReference Include="System.Security.Principal.Windows" />
    <PackageReference Include="System.Text.Json" />
    <PackageReference Include="System.Collections.Immutable" />
    <PackageReference Include="System.Threading.Tasks.Dataflow" />
  </ItemGroup>

  <ItemGroup Condition="'$(TargetFrameworkIdentifier)' == '.NETStandard'">
    <PackageReference Include="System.Reflection.Metadata" />
    <PackageReference Include="System.Text.Encoding.CodePages" />
  </ItemGroup>

  <ItemGroup>
    <Compile Include="..\Shared\BuildEnvironmentHelper.cs">
      <Link>SharedUtilities\BuildEnvironmentHelper.cs</Link>
    </Compile>
    <Compile Include="..\Shared\EncodingStringWriter.cs">
      <Link>SharedUtilities\EncodingStringWriter.cs</Link>
    </Compile>
    <Compile Include="..\Shared\AssemblyNameComparer.cs">
      <Link>SharedUtilities\AssemblyNameComparer.cs</Link>
    </Compile>
    <Compile Include="..\Shared\AwaitExtensions.cs">
      <Link>SharedUtilities\AwaitExtensions</Link>
    </Compile>
    <Compile Include="..\Shared\AssemblyNameReverseVersionComparer.cs">
      <Link>SharedUtilities\AssemblyNameReverseVersionComparer.cs</Link>
    </Compile>
    <Compile Include="..\Shared\CanonicalError.cs">
      <Link>BackEnd\Components\RequestBuilder\IntrinsicTasks\CanonicalError.cs</Link>
    </Compile>
    <Compile Include="..\Shared\PropertyParser.cs">
      <Link>BackEnd\Components\RequestBuilder\IntrinsicTasks\PropertyParser.cs</Link>
    </Compile>
    <Compile Include="..\Shared\StringExtensions.cs">
      <Link>SharedUtilities\StringExtensions.cs</Link>
    </Compile>
    <Compile Include="..\Shared\StringUtils.cs">
      <Link>SharedUtilities\StringUtils.cs</Link>
    </Compile>
    <Compile Include="..\Shared\ReadOnlyEmptyCollection.cs">
      <Link>Collections\ReadOnlyEmptyCollection.cs</Link>
    </Compile>
    <Compile Include="..\Shared\BufferedReadStream.cs" />
    <Compile Include="..\Shared\TaskFactoryUtilities.cs" />
    <Compile Include="..\GlobalUsings.cs" Link="GlobalUsings.cs" />
    <Compile Include="..\Shared\TaskHostConfiguration.cs" />
    <Compile Include="..\Shared\TaskHostTaskCancelled.cs" />
    <Compile Include="..\Shared\TaskHostTaskComplete.cs" />
    <Compile Include="..\Shared\OutOfProcTaskHostTaskResult.cs" />
    <Compile Include="..\Shared\TaskLoader.cs" />
    <Compile Include="..\Shared\NodeEngineShutdownReason.cs" />
    <Compile Include="..\Shared\IKeyed.cs" />
    <Compile Include="..\Shared\INodeEndpoint.cs" />
    <Compile Include="..\Shared\NodeEndpointOutOfProcBase.cs" />
    <Compile Include="..\Shared\INodePacket.cs" />
    <Compile Include="..\Shared\INodePacketFactory.cs" />
    <Compile Include="..\Shared\INodePacketHandler.cs" />
    <Compile Include="..\Shared\LogMessagePacketBase.cs" />
    <Compile Include="..\Shared\NodePacketFactory.cs" />
    <Compile Include="..\Shared\NodeBuildComplete.cs" />
    <Compile Include="..\Shared\NodeShutdown.cs" />
    <Compile Include="..\Shared\NamedPipeUtil.cs" />
    <Compile Include="..\Shared\ProcessExtensions.cs" />
    <Compile Include="..\Shared\PlatformNegotiation.cs">
      <Link>PlatformNegotiation.cs</Link>
    </Compile>
    <Compile Include="..\Shared\SolutionConfiguration.cs" />
    <Compile Include="..\Shared\TaskLoggingHelper.cs">
      <Link>BackEnd\Components\RequestBuilder\IntrinsicTasks\TaskLoggingHelper.cs</Link>
    </Compile>
    <Compile Include="..\Shared\TaskLoggingHelperExtension.cs">
      <Link>BackEnd\Components\RequestBuilder\IntrinsicTasks\TaskLoggingHelperExtension.cs</Link>
    </Compile>
    <Compile Include="..\Shared\TaskParameter.cs" />
    <Compile Include="..\Shared\TaskParameterTypeVerifier.cs" />
    <Compile Include="..\Shared\TranslatorHelpers.cs" />
    <Compile Include="..\Shared\CommunicationsUtilities.cs" />
    <Compile Include="..\Shared\InterningBinaryReader.cs" />
    <Compile Include="..\Shared\TaskEngineAssemblyResolver.cs" />
    <Compile Include="..\Shared\ThreadPoolExtensions.cs" />
    <Compile Include="..\Shared\RegisteredTaskObjectCacheBase.cs" />
    <Compile Include="..\Shared\CollectionHelpers.cs" />
    <Compile Include="..\Shared\CopyOnWriteDictionary.cs">
      <Link>Collections\CopyOnWriteDictionary.cs</Link>
    </Compile>
    <Compile Include="..\Shared\ReadOnlyCollection.cs" />
    <Compile Include="..\Shared\ToolsetElement.cs" />
    <Compile Include="..\Shared\AssemblyLoadInfo.cs">
      <Link>SharedUtilities\AssemblyLoadInfo.cs</Link>
    </Compile>
    <Compile Include="..\Shared\ReadOnlyEmptyDictionary.cs">
      <Link>SharedUtilities\ReadOnlyEmptyDictionary.cs</Link>
    </Compile>
    <Compile Include="..\Shared\AssemblyNameExtension.cs">
      <Link>SharedUtilities\AssemblyNameExtension.cs</Link>
    </Compile>
    <Compile Include="..\Shared\BuildEventFileInfo.cs">
      <Link>SharedUtilities\BuildEventFileInfo.cs</Link>
    </Compile>
    <Compile Include="..\Shared\ConversionUtilities.cs">
      <Link>SharedUtilities\ConversionUtilities.cs</Link>
    </Compile>
    <Compile Include="..\Shared\FileDelegates.cs">
      <Link>SharedUtilities\FileDelegates.cs</Link>
    </Compile>
    <Compile Include="..\Shared\ErrorUtilities.cs">
      <Link>Errors\ErrorUtilities.cs</Link>
    </Compile>
    <Compile Include="..\Shared\EscapingUtilities.cs">
      <Link>SharedUtilities\EscapingUtilities.cs</Link>
    </Compile>
    <Compile Include="..\Shared\VersionUtilities.cs">
      <Link>SharedUtilities\VersionUtilities.cs</Link>
    </Compile>
    <Compile Include="..\Shared\EventArgsFormatting.cs">
      <Link>SharedUtilities\EventArgsFormatting.cs</Link>
    </Compile>
    <Compile Include="..\Shared\ExceptionHandling.cs">
      <Link>SharedUtilities\ExceptionHandling.cs</Link>
    </Compile>
    <Compile Include="..\Shared\FileMatcher.cs">
      <Link>SharedUtilities\FileMatcher.cs</Link>
    </Compile>
    <Compile Include="..\Shared\FileUtilities.cs">
      <Link>SharedUtilities\FileUtilities.cs</Link>
    </Compile>
    <Compile Include="..\Shared\TempFileUtilities.cs" />
    <Compile Include="..\Shared\Modifiers.cs" />
    <Compile Include="..\Shared\FileUtilitiesRegex.cs">
      <Link>SharedUtilities\FileUtilitiesRegex.cs</Link>
    </Compile>
    <Compile Include="..\Shared\FrameworkLocationHelper.cs">
      <Link>SharedUtilities\FrameworkLocationHelper.cs</Link>
    </Compile>
    <Compile Include="..\Shared\IElementLocation.cs">
      <Link>SharedUtilities\IElementLocation.cs</Link>
    </Compile>
    <Compile Include="..\Shared\LoadedType.cs">
      <Link>SharedUtilities\LoadedType.cs</Link>
    </Compile>
    <Compile Include="..\Shared\TypeUtilities.cs">
      <Link>SharedUtilities\TypeUtilities.cs</Link>
    </Compile>
    <Compile Include="..\Shared\InprocTrackingNativeMethods.cs">
      <Link>InprocTrackingNativeMethods.cs</Link>
    </Compile>
    <Compile Include="..\Shared\ProjectErrorUtilities.cs">
      <Link>Errors\ProjectErrorUtilities.cs</Link>
    </Compile>
    <Compile Include="..\Shared\ProjectFileErrorUtilities.cs">
      <Link>Errors\ProjectFileErrorUtilities.cs</Link>
    </Compile>
    <Compile Include="..\Shared\ProjectWriter.cs">
      <Link>SharedUtilities\ProjectWriter.cs</Link>
    </Compile>
    <Compile Include="..\Shared\ResourceUtilities.cs">
      <Link>SharedUtilities\ResourceUtilities.cs</Link>
    </Compile>
    <Compile Include="..\Shared\Tracing.cs" />
    <Compile Include="..\Shared\CoreCLRAssemblyLoader.cs" Condition="'$(TargetFrameworkIdentifier)'!='.NETFramework'" />
    <Compile Include="..\Shared\TypeLoader.cs">
      <Link>SharedUtilities\TypeLoader.cs</Link>
    </Compile>
    <Compile Include="..\Shared\MSBuildLoadContext.cs" Condition="'$(TargetFrameworkIdentifier)'!='.NETFramework'">
      <Link>SharedUtilities\MSBuildLoadContext.cs</Link>
    </Compile>
    <Compile Include="..\Shared\VisualStudioConstants.cs">
      <Link>VisualStudioConstants.cs</Link>
    </Compile>
    <Compile Include="..\Shared\XMakeAttributes.cs">
      <Link>Resources\XMakeAttributes.cs</Link>
    </Compile>
    <Compile Include="..\Shared\XMakeElements.cs">
      <Link>Resources\XMakeElements.cs</Link>
    </Compile>
    <Compile Include="..\Shared\XmlUtilities.cs">
      <Link>SharedUtilities\XmlUtilities.cs</Link>
    </Compile>

    <!-- Win32 RC Files -->
    <RCResourceFile Include="native.rc" />
    
    <!-- Resource Files -->
    <EmbeddedResource Update="Resources\Strings.resx">
      <LogicalName>$(AssemblyName).Strings.resources</LogicalName>
      <SubType>Designer</SubType>
    </EmbeddedResource>
  </ItemGroup>

  <PropertyGroup>
    <NuGetFrameworkWrapperRedirects_FilePath>$(IntermediateOutputPath)NuGetFrameworkWrapper.redirects.cs</NuGetFrameworkWrapperRedirects_FilePath>
  </PropertyGroup>

  <!-- Extract binding redirects for MSBuild and dependencies from MSBuild.exe.config into a source file.
       This allows us to create secondary AppDomains with the same redirects at run-time, see
       https://github.com/dotnet/msbuild/blob/main/documentation/NETFramework-NGEN.md#nugetframeworks -->
  <Target Name="GenerateAppDomainConfig" Inputs="..\MSBuild\app.config;..\MSBuild\app.amd64.config;$(MSBuildThisFileFullPath)" Outputs="$(NuGetFrameworkWrapperRedirects_FilePath)" BeforeTargets="CoreCompile" Condition="'$(FeatureAppDomain)' == 'true'">
    <PropertyGroup>
      <BindingRedirectNamespace>&lt;Namespace Prefix='ns' Uri='urn:schemas-microsoft-com:asm.v1' /&gt;</BindingRedirectNamespace>
      <BindingRedirectXPath>/configuration/runtime/ns:assemblyBinding/*</BindingRedirectXPath>
    </PropertyGroup>

    <XmlPeek XmlInputPath="..\MSBuild\app.config" Query="$(BindingRedirectXPath)" Namespaces="$(BindingRedirectNamespace)">
      <Output TaskParameter="Result" ItemName="BindingRedirects32" />
    </XmlPeek>
    <XmlPeek XmlInputPath="..\MSBuild\app.amd64.config" Query="$(BindingRedirectXPath)" Namespaces="$(BindingRedirectNamespace)">
      <Output TaskParameter="Result" ItemName="BindingRedirects64" />
    </XmlPeek>

    <PropertyGroup>
      <NuGetFrameworkWrapperRedirects_Content><![CDATA[
// Licensed to the .NET Foundation under one or more agreements.
// The .NET Foundation licenses this file to you under the MIT license.

namespace Microsoft.Build.Evaluation%3B;

[System.CodeDom.Compiler.GeneratedCode("GenerateAppDomainConfig", "1.0")]
internal sealed partial class NuGetFrameworkWrapper
{
    private const string _bindingRedirects32 = """;@(BindingRedirects32);"""%3B;
    private const string _bindingRedirects64 = """;@(BindingRedirects64);"""%3B;
}
]]>
      </NuGetFrameworkWrapperRedirects_Content>
    </PropertyGroup>

    <WriteLinesToFile File="$(NuGetFrameworkWrapperRedirects_FilePath)" Overwrite="true" WriteOnlyWhenDifferent="true" Lines="$(NuGetFrameworkWrapperRedirects_Content)" />

    <ItemGroup>
      <Compile Remove="$(NuGetFrameworkWrapperRedirects_FilePath)" />
      <Compile Include="$(NuGetFrameworkWrapperRedirects_FilePath)">
        <Link>Utilities\NuGetFrameworkWrapper.redirects.cs</Link>
      </Compile>
      <FileWrites Include="$(NuGetFrameworkWrapperRedirects_FilePath)" />
    </ItemGroup>
  </Target>
</Project>
